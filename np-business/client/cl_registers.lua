local activeRegisters = {
    {
        polytarget = {
            vector3(1133.23, -468.62, 66.48), 1.0, 0.6, {
                heading=346,
                minZ=66.28,
                maxZ=66.88
            }
        },
        business="digital_den",
    },
    {
        polytarget = {
            vector3(-419.7, 29.11, 46.23), 1, 1, {
                heading=350,
                minZ=46.23,
                maxZ=46.83
            }
        },
        business="gallery",
    },
    {
        polytarget = {
            vector3(-421.56, 30.0, 46.23), 1, 1, {
                heading=315,
                minZ=46.23,
                maxZ=46.83
            }
        },
        business="gallery",
    },
    {
        polytarget = {
            vector3(-422.63, 32.47, 46.23), 1, 1, {
                heading=270,
                minZ=46.23,
                maxZ=46.83
            }
        },
        business="gallery",
    },
    {
        polytarget = {
            vector3(-488.68, 39.5, 53.6), 0.7, 0.7, {
                heading=355,
                minZ=52.45,
                maxZ=52.95
            }
        },
        business="gallery",
    },
    {
        polytarget = {
            vector3(-488.86, 37.55, 52.41), 0.7, 0.7, {
                heading=354,
                minZ=52.46,
                maxZ=52.96
            }
        },
        business="gallery",
    },
    {
        polytarget = {
            vector3(1114.24, 206.66, -49.44), 2, 1, {
                heading=56,
                minZ=-49.64,
                maxZ=-49.04
            }
        },
        business="casino",
    },
    {
        polytarget = {
            vector3(1109.7, 206.57, -49.44), 1, 2, {
                heading=36,
                minZ=-49.64,
                maxZ=-49.04
            }
        },
        business="casino",
    },
    {
        polytarget = {
            vector3(1111.8, 210.72, -49.44), 2, 1, {
                heading=3,
                minZ=-49.64,
                maxZ=-49.04
            }
        },
        business="casino",
    },
    {
        polytarget = {
            vector3(320.64, 181.38, 103.59), 0.6, 0.6, {
                heading=340,
                minZ=103.59,
                maxZ=104.19
            }
        },
        business="btat",
    },
    {
        polytarget = {
            vector3(-821.61, -183.79, 37.57), 0.6, 0.8, {
                name="bobmulet",
                heading=30,
                minZ=37.37,
                maxZ=37.97
            }
        },
        business="bobby_brown",
    },
    {
        polytarget = {
            vector3(-140.92, 224.71, 94.99), 0.8, 0.8, {
                name="comicregister",
                heading=0,
                minZ=94.79,
                maxZ=95.39
            }
        },
        business="comic_store",
    },
    {
        polytarget = {
            vector3(-1379.53, -629.54, 30.82), 1.2, 0.8, {
                heading=33,
                minZ=30.82,
                maxZ=31.42
            }
        },
        business="bahamas_public",
        public = true,
    },
    {
        polytarget = {
            vector3(-1376.56, -627.61, 30.82), 1.2, 0.8, {
                heading=33,
                minZ=30.82,
                maxZ=31.42
            }
        },
        business="bahamas_public",
        public = true,
    },
    {
        polytarget = {
            vector3(-1391.31, -607.75, 30.32), 1.4, 1.2, {
                heading=132,
                minZ=30.32,
                maxZ=30.92
            }
        },
        business="bahamas_public",
        public = true,
    },
    {
        polytarget = {
            vector3(-1393.0, -604.98, 30.32), 1.4, 1.2, {
                heading=112,
                minZ=30.32,
                maxZ=30.92
            }
        },
        business="bahamas_public",
        public = true,
    },
    {
        polytarget = {
            vector3(-560.8, 287.39, 82.18), 0.8, 1.5, {
                heading=355,
                minZ=81.58,
                maxZ=83.18
            }
        },
        business="teqilala_public",
        public = true,
    },
    {
        polytarget = {
            vector3(-561.08, 284.61, 82.18), 0.8, 1.5, {
                heading=355,
                minZ=81.58,
                maxZ=83.18
            }
        },
        business="teqilala_public",
        public = true,
    },
    -- {
    --     polytarget = {
    --         vector3(-442.16, 269.04, 83.02), 1, 0.8, {
    --             name="ssr",
    --             heading=355,
    --             minZ=83.02,
    --             maxZ=83.42
    --         }
    --     },
    --     business="split_sides",
    -- },
    {
        polytarget = {
            vector3(1985.16, 3054.34, 47.22), 0.85, 1.0, {
                name="yellowjack",
                heading=328,
                minZ=47.22,
                maxZ=47.67
            }
        },
        business="yellow_jack",
    },
    {
        polytarget = {
            vector3(-46.24, -1166.44, 26.1), 0.8, 0.6, {
                name="bogg_register",
                heading=199,
                minZ=25.35,
                maxZ=26.85,
            }
        },
        business="bogg_bikes",
    },
    {
        polytarget = {
            vector3(-1379.53, -629.54, 30.82), 1.2, 0.8, {
                heading=33,
                minZ=30.82,
                maxZ=31.42
            }
        },
        whitelistedOnly = true,
        business="bahama_mamas",
    },
    {
        polytarget = {
            vector3(-1376.56, -627.61, 30.82), 1.2, 0.8, {
                heading=33,
                minZ=30.82,
                maxZ=31.42
            }
        },
        whitelistedOnly = true,
        business="bahama_mamas",
    },
    {
        polytarget = {
            vector3(-1391.31, -607.75, 30.32), 1.4, 1.2, {
                heading=132,
                minZ=30.32,
                maxZ=30.92
            }
        },
        whitelistedOnly = true,
        business="bahama_mamas",
    },
    {
        polytarget = {
            vector3(-1393.0, -604.98, 30.32), 1.4, 1.2, {
                heading=112,
                minZ=30.32,
                maxZ=30.92
            }
        },
        whitelistedOnly = true,
        business="bahama_mamas",
    },
    {
        polytarget = {
            vector3(86.42, -1417.36, 29.28), 0.6, 0.7, {
                heading=140,
                minZ=29.28,
                maxZ=29.88
            }
        },
        business="kiki_organic_clothing",
    },
    {
        polytarget = {
            vector3(-659.91, -858.11, 24.52), 0.65, 0.75, {
                heading=0,
                minZ=24.22,
                maxZ=24.82
            }
        },
        business="pixel_perfect",
    },
    {
        polytarget = {
            vector3(-730.73, -1137.69, 10.83), 0.6, 0.6, {
                heading=307,
                minZ=10.63,
                maxZ=11.23
            }
        },
        business="pawnhub",
    },
    {
        polytarget = {
            vector3(-731.46, -1128.89, 10.83), 0.6, 0.6, {
                heading=304,
                minZ=10.83,
                maxZ=11.23
            }
        },
        business="pawnhub",
    },
    {
        polytarget = {
            vector3(-618.01, -1141.77, 16.73), 0.5, 0.5, {
                heading=0,
                minZ=16.73,
                maxZ=17.13
            }
        },
        business="demons_den",
    },
    {
        polytarget = {
            vector3(-1152.27, -1424.8, 4.95), 0.6, 0.6, {
                heading=0,
                minZ=4.9,
                maxZ=5.5
            }
        },
        business="the_pit_tattoo_parlor",
    }
}

local activePurchases = {}

Citizen.CreateThread(function()
    while not exports['np-config']:IsConfigReady() do
        Wait(100)
    end
    local areRegistersPublic = exports['np-config']:GetMiscConfig("business.registers.public")
    for id,register in ipairs(activeRegisters) do
        if register.public and not areRegistersPublic then goto continue end
        if register.whitelistedOnly and exports['np-config']:GetServerType() ~= "whitelisted" then goto continue end

        local ptId = "np-business:register_" .. id
        exports["np-polytarget"]:AddBoxZone(ptId, register.polytarget[1], register.polytarget[2], register.polytarget[3], register.polytarget[4])
        exports['np-interact']:AddPeekEntryByPolyTarget(ptId, {{
            event = "np-business:registerPurchasePrompt",
            id = ptId .. "_purchase",
            icon = "cash-register",
            label = "make payment",
            parameters = {registerId = id, business = register.business}
        }}, { distance = { radius = 2.0 } })

        exports['np-interact']:AddPeekEntryByPolyTarget(ptId, {{
            event = "np-business:registerChargePrompt",
            id = ptId .. "_charge",
            icon = "credit-card",
            label = "Charge Customer",
            parameters = {registerId = id, business = register.business}
        }}, { distance = { radius = 2.0 }, isEnabled = function(pEntity, pContext) return IsEmployedAt(register.business) end})
        ::continue::
    end
end)

AddEventHandler('np-business:registerPurchasePrompt', function(pParameters, pEntity, pContext)
    local activeRegisterId = pParameters.registerId
    local activeRegister = activePurchases[activeRegisterId]
    if not activeRegister or activeRegister == nil then
        TriggerEvent("DoLongHudText", "No purchase active.")
        return
    end
    local priceWithTax = RPC.execute("PriceWithTaxString", activeRegister.cost, "Goods")
    local acceptContext = {{
        title = "Accept Purchase",
        description = "$" .. priceWithTax.text .. " | " .. activeRegister.comment,
        action = "np-business:finishPurchasePrompt",
        key = {cost = activeRegister.cost, comment = activeRegister.comment, registerId = pParameters.registerId, business = pParameters.business, charger = activeRegister.charger},
        disabled = false
    }}
    exports['np-ui']:showContextMenu(acceptContext)
end)

AddEventHandler('np-business:registerChargePrompt', function(pParameters, pEntity, pContext)
    exports['np-ui']:openApplication('textbox', {
        callbackUrl = 'np-ui:business:charge',
        key = {registerId = pParameters.registerId, business = pParameters.business},
        items = {
          {
            icon = "dollar-sign",
            label = "Cost",
            name = "cost",
          },
          {
            icon = "pencil-alt",
            label = "Comment",
            name = "comment",
          },
        },
        show = true,
    })
end)

--Add to purchases at registerId pos
RegisterNetEvent('np-business:activePurchase')
AddEventHandler("np-business:activePurchase", function(data)
    activePurchases[data.registerId] = data
end)

--Remove at registerId pos
RegisterNetEvent('np-business:closePurchase')
AddEventHandler("np-business:closePurchase", function(data)
    activePurchases[data.registerId] = nil
end)

RegisterUICallback('np-business:finishPurchasePrompt', function (data, cb)
    cb({ data = {}, meta = { ok = true, message = '' } })
    local success = RPC.execute("np-business:completePurchase", data.key)
    if not success then
        TriggerEvent("DoLongHudText", "The purchase could not be completed.")
    end
end)

RegisterUICallback("np-ui:business:charge", function(data, cb)
    cb({ data = {}, meta = { ok = true, message = '' } })
    exports['np-ui']:closeApplication('textbox')
    local cost = tonumber(data.values.cost)
    local comment = data.values.comment
    --check if cost is actually a number
    if cost == nil or not cost then return end
    if comment == nil then comment = "" end

    if cost < 1 then cost = 1 end --Minimum $1

    --Send event to everyone indicating a purchase is ready at specified register
    RPC.execute("np-business:startPurchase", {cost = cost, comment = comment, registerId = data.key.registerId, business = data.key.business})
end)
